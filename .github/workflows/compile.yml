name: compile typst

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Typst
        uses: typst-community/setup-typst@v4
        with:
          version: latest

      - name: Compile main.typ to main.pdf
        run: typst compile main.typ main.pdf

      - name: Delete existing 'main' artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch all artifacts in this repo and delete those named 'main'
          artifacts=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/artifacts \
            --jq '.artifacts[] | select(.name == "main") | .id')
          
          for id in $artifacts; do
            echo "Deleting artifact ID: $id"
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/actions/artifacts/$id
          done

      - name: Upload new artifact
        uses: actions/upload-artifact@v4
        with:
          name: main
          path: main.pdf
